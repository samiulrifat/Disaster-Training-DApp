<!DOCTYPE html>
<html>
<head>
  <title>Disaster Recovery DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
<body>
  <h2>Disaster Recovery Training DApp</h2>


  <h3>Participant Registration</h3>
  <input id="participant_name" type="text" placeholder="Name" />
  <input id="participant_age" type="number" placeholder="Age" />
  <input id="participant_gender" type="text" placeholder="Gender" />
  <input id="participant_district" type="text" placeholder="District" />
  <select id="participant_interest">
    <option value="1">first_aid</option>
    <option value="2">shelter_rebuild</option>
    <option value="3">food_safety</option>
  </select>
  <button onclick="registerAsParticipant()">Register as Participant</button>


  <h3>Admin and Trainer Registration</h3>
  <button onclick="registerAsAdmin()">Register as Admin</button>
  <button onclick="registerAsTrainer()">Register as Trainer</button>


  <p id="output" style="margin-top:20px; font-weight:bold;"></p>

  <h3>Book Training Slot</h3>
  <label for="trainer_address">Trainer Address:</label>
  <input id="trainer_address" type="text" placeholder="0x..." size="42" />

  <label for="slot_index">Training Slot (1-6):</label>
  <input id="slot_index" type="number" min="1" max="6" />

  <button onclick="bookTrainingSlot()">Book Slot</button>

  <p id="booking_output" style="font-weight:bold;"></p>

  <h3>Trainers and Their Schedules</h3>
  <div id="trainers_list"></div>

  <h3>Update Participant Data (Admin Only)</h3>

  <label for="participant_address">Participant Address:</label>
  <input id="participant_address" type="text" placeholder="0x..." size="42" />

  <label for="new_interest">New Training Interest:</label>
  <select id="new_interest">
    <option value="0">--Select--</option>
    <option value="1">First Aid</option>
    <option value="2">Shelter Rebuild</option>
    <option value="3">Food Safety</option>
  </select>

  <label for="set_completed">Mark Training Completed:</label>
  <input id="set_completed" type="checkbox" />

  <button onclick="updateParticipantData()">Update Participant</button>

  <p id="update_output" style="font-weight:bold;"></p>

  <h3>Search Participants By District</h3>
  <input id="search_district" type="text" placeholder="Enter district" />
  <button onclick="searchParticipants()">Search</button>
  <div id="search_output"></div>

  <h3>Upload Certificate (Admin Only)</h3>
  <input type="text" id="participant_address_cert" placeholder="Participant Address" size="42" />
  <input type="file" id="certificate_file" />
  <button onclick="uploadAndSetCertificate()">Upload & Link Certificate</button>
  <p id="certificate_output"></p>

  <button onclick="viewCertificate()">View Certificate</button>


  <script>
    let web3;
    let contract;
    let account;


    const contractABI = [
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "admin",
          "type": "address"
        }
      ],
      "name": "AdminRegistered",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "participant",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "string",
          "name": "field",
          "type": "string"
        }
      ],
      "name": "DataUpdated",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "participant",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        }
      ],
      "name": "ParticipantRegistered",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "trainer",
          "type": "address"
        }
      ],
      "name": "TrainerRegistered",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "participant",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "address",
          "name": "trainer",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint8",
          "name": "slot",
          "type": "uint8"
        }
      ],
      "name": "TrainingBooked",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "BOOKING_FEE",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "admins",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "participants",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "id",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "name",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "age",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "gender",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "district",
          "type": "string"
        },
        {
          "internalType": "enum DisasterTraining.TrainingInterest",
          "name": "training_interest",
          "type": "uint8"
        },
        {
          "internalType": "bool",
          "name": "has_completed_training",
          "type": "bool"
        },
        {
          "internalType": "address",
          "name": "wallet",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "name": "trainers",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "userRoles",
      "outputs": [
        {
          "internalType": "enum DisasterTraining.UserRole",
          "name": "",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "registerAsAdmin",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "registerAsTrainer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "string",
          "name": "_name",
          "type": "string"
        },
        {
          "internalType": "uint256",
          "name": "_age",
          "type": "uint256"
        },
        {
          "internalType": "string",
          "name": "_gender",
          "type": "string"
        },
        {
          "internalType": "string",
          "name": "_district",
          "type": "string"
        },
        {
          "internalType": "uint8",
          "name": "_interest",
          "type": "uint8"
        }
      ],
      "name": "registerAsParticipant",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "getTrainersLength",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "participantAddr",
          "type": "address"
        },
        {
          "internalType": "uint8",
          "name": "newInterest",
          "type": "uint8"
        },
        {
          "internalType": "bool",
          "name": "setCompleted",
          "type": "bool"
        }
      ],
      "name": "updateParticipant",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "trainer",
          "type": "address"
        },
        {
          "internalType": "uint8",
          "name": "slotIndex",
          "type": "uint8"
        }
      ],
      "name": "bookTrainingSlot",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function",
      "payable": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "trainer",
          "type": "address"
        }
      ],
      "name": "viewTrainerSchedule",
      "outputs": [
        {
          "internalType": "address[6]",
          "name": "",
          "type": "address[6]"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    }
  ];


    const contractAddress = "0x3d50C3a292Bc30D99aA4f97149683e6F01dB5f0a"; 


    window.addEventListener('load', async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          account = accounts[0];
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById('output').innerText = `Connected account: ${account}`;
          if (contract) {
            loadTrainersAndSchedules();
          }

        } catch (error) {
          alert("User denied account access");
        }
      } else {
        alert("Please install MetaMask!");
      }
    });


    async function registerAsAdmin() {
      try {
        await contract.methods.registerAsAdmin().send({ from: account });
        document.getElementById('output').innerText = "Registered as Admin successfully!";
      } catch (err) {
        document.getElementById('output').innerText = "Error: " + err.message;
      }
    }


    async function registerAsTrainer() {
      try {
        await contract.methods.registerAsTrainer().send({ from: account });
        document.getElementById('output').innerText = "Registered as Trainer successfully!";
      } catch (err) {
        document.getElementById('output').innerText = "Error: " + err.message;
      }
    }


    async function registerAsParticipant() {
    if (!contract) {
        alert("Contract is not initialized");
        return;
    }

    const name = document.getElementById('participant_name').value;
    const age = parseInt(document.getElementById('participant_age').value);
    const gender = document.getElementById('participant_gender').value;
    const district = document.getElementById('participant_district').value;
    const interest = parseInt(document.getElementById('participant_interest').value);

    if (!name || !age || !gender || !district || !interest) {
        document.getElementById('output').innerText = "Please fill in all required fields.";
        return;
    }

    try {
        await contract.methods.registerAsParticipant(name, age, gender, district, interest).send({ from: account });
        document.getElementById('output').innerText = "Registered as Participant successfully!";
    } catch (err) {
        document.getElementById('output').innerText = "Error: " + err.message;
    }
    }

    async function bookTrainingSlot() {
    const trainer = document.getElementById('trainer_address').value.trim();
    const slotStr = document.getElementById('slot_index').value.trim();
    const slotIndex = parseInt(slotStr);

    if (!web3.utils.isAddress(trainer)) {
        document.getElementById('booking_output').innerText = "Invalid trainer address.";
        return;
    }
    if (![1, 2, 3, 4, 5, 6].includes(slotIndex)) {
        document.getElementById('booking_output').innerText = "Slot must be a number between 1 and 6.";
        return;
    }

    try {
        // Get booking fee from contract
        const bookingFee = await contract.methods.BOOKING_FEE().call();
    
        await contract.methods.bookTrainingSlot(trainer, slotIndex).send({ 
        from: account, 
        value: bookingFee 
        });
        document.getElementById('booking_output').innerText = "Training slot booked successfully!";
    } catch (err) {
        document.getElementById('booking_output').innerText = "Error: " + err.message;
    }
    }

    // Fetch and display all registered trainers and their schedules
async function loadTrainersAndSchedules() {
  const trainersDiv = document.getElementById('trainers_list');
  trainersDiv.innerHTML = "Loading trainers...";

  try {
    
    const trainersCount = await contract.methods.getTrainersLength().call()

  
    if (!trainersCount) {
      trainersDiv.innerText = "Unable to load trainers count.";
      return;
    }

    let trainersHTML = "";

    for (let i = 0; i < trainersCount; i++) {
      const trainerAddress = await contract.methods.trainers(i).call();

      trainersHTML += `<div style="margin-bottom:20px;">
        <b>Trainer:</b> ${trainerAddress}
        <br/>
        <button onclick="showTrainerSchedule('${trainerAddress}', ${i})">View Schedule</button>
        <div id="schedule_${i}"></div>
      </div>`;
    }

    trainersDiv.innerHTML = trainersHTML;
  } catch (error) {
    trainersDiv.innerText = "Error loading trainers: " + error.message;
  }
}

// Show schedule of a specific trainer: 6 slots
async function showTrainerSchedule(trainerAddress, idx) {
  const scheduleDiv = document.getElementById(`schedule_${idx}`);
  scheduleDiv.innerHTML = "Loading schedule...";

  try {
    const schedule = await contract.methods.viewTrainerSchedule(trainerAddress).call();

    let scheduleHTML = "<ol>";

    for (let i = 0; i < schedule.length; i++) {
      scheduleHTML += `<li>Slot ${i+1}: ${schedule[i] === '0x0000000000000000000000000000000000000000' ? "Available" : schedule[i]}</li>`;
    }

    scheduleHTML += "</ol>";

    scheduleDiv.innerHTML = scheduleHTML;
  } catch (error) {
    scheduleDiv.innerHTML = "Error loading schedule: " + error.message;
  }
}

async function updateParticipantData() {
  const participantAddress = document.getElementById('participant_address').value.trim();
  const newInterest = parseInt(document.getElementById('new_interest').value);
  const setCompleted = document.getElementById('set_completed').checked;

  if (!web3.utils.isAddress(participantAddress)) {
    document.getElementById('update_output').innerText = "Invalid participant address.";
    return;
  }

  if (newInterest !== 0 && (newInterest < 1 || newInterest > 3)) {
    document.getElementById('update_output').innerText = "Invalid training interest selected.";
    return;
  }

  try {
    await contract.methods.updateParticipant(participantAddress, newInterest, setCompleted)
      .send({ from: account });
    document.getElementById('update_output').innerText = "Participant data updated successfully!";
  } catch (error) {
    document.getElementById('update_output').innerText = "Error: " + error.message;
  }
}


async function searchParticipantsByDistrict(searchDistrict) {
  const total = await contract.methods.getTotalParticipants().call();
  let participantsList = [];

  for (let i = 0; i < total; i++) {
    const addr = await contract.methods.participantAddresses(i).call();
    const p = await contract.methods.participants(addr).call();
    participantsList.push({ address: addr, district: p.district, name: p.name });
  }

  // Filter by district (case insensitive)
  const filtered = participantsList.filter(p => 
    p.district.toLowerCase() === searchDistrict.toLowerCase()
  );

  // Count participants per district
  let counts = {};
  participantsList.forEach(p => {
    const d = p.district;
    counts[d] = counts[d] ? counts[d] + 1 : 1;
  });

  // Sort districts by count descending
  let sortedDistricts = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
  
  // Display results
  console.log("Participants in", searchDistrict, filtered.length);
  console.log("Participants count per district:");
  sortedDistricts.forEach(d => console.log(d, counts[d]));

}

async function searchParticipants() {
  const district = document.getElementById('search_district').value.trim();
  if (!district) {
    alert("Please enter a district");
    return;
  }
  await searchParticipantsByDistrict(district);
}

async function uploadAndSetCertificate() {
  const participantAddress = document.getElementById('participant_address_cert').value.trim();
  const fileInput = document.getElementById('certificate_file');
  if (!web3.utils.isAddress(participantAddress)) {
    document.getElementById('certificate_output').innerText = 'Invalid participant address.';
    return;
  }
  if (fileInput.files.length === 0) {
    document.getElementById('certificate_output').innerText = 'No file selected.';
    return;
  }

  try {
    const file = fileInput.files[0];
    document.getElementById('certificate_output').innerText = 'Uploading to IPFS...';
    const cid = await uploadCertificate(file);  // Use IPFS client upload
    document.getElementById('certificate_output').innerText = `Uploaded to IPFS: ${cid}. Sending transaction...`;

    await contract.methods.setCertificate(participantAddress, cid)
      .send({ from: account });

    document.getElementById('certificate_output').innerText = 'Certificate linked successfully!';
  } catch (err) {
    document.getElementById('certificate_output').innerText = 'Error: ' + err.message;
  }
}

async function viewCertificate() {
  const participantAddress = document.getElementById('participant_address_cert').value.trim();
  if (!web3.utils.isAddress(participantAddress)) {
    alert('Invalid participant address.');
    return;
  }
  const cid = await contract.methods.getCertificate(participantAddress).call();
  if (cid) {
    const url = `https://ipfs.io/ipfs/${cid}`;
    window.open(url, '_blank');
  } else {
    alert('No certificate found for this participant.');
  }
}


  </script>

  <script type="module">
  import { create } from 'https://unpkg.com/ipfs-http-client@59.0.0/dist/index.min.js';

  const ipfs = create({ url: 'https://ipfs.infura.io:5001/api/v0' });

  window.uploadCertificate = async function(file) {
      const added = await ipfs.add(file);
      return added.path;
  }
  
  </script>

</body>
</html>
